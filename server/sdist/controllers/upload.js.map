{"version":3,"sources":["../../controllers/upload.js"],"names":["log","log4js","getLogger","storageDir","common","getStorageDir","tempDir","path","join","storage","multer","diskStorage","destination","filename","req","file","cb","Date","now","originalname","upload","tag","module","exports","type","required","description","appId","platform","enum","appVersion","active","grayScaleSize","default","changeLog","updateMode","single","PublishRouter","ctx","next","console","uid","state","user","data","_id","body","appInfo","verify","checkApp","checkRole","version","versionManager","releaseVersions","debug"],"mappings":"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","file":"upload.js","sourcesContent":["import {\n  request,\n  summary,\n  tags,\n  formData,middlewares\n} from '../swagger';\nimport {responseWrapper} from \"../utils/util\";\nimport verify from '../utils/verify'\nimport versionManager from  '../services/version-manager';\nimport log4js  from 'log4js'\nimport multer from \"koa-multer\";\nimport path from \"path\";\nimport common from \"../utils/common\";\nconst log = log4js.getLogger(\"cps:upload\");\n\nlet storageDir = common.getStorageDir()\nconst tempDir = path.join(storageDir, 'tmp');\nconst storage = multer.diskStorage({\n    destination: tempDir,\n    filename: (req, file, cb) => cb(null, `${Date.now()}-${file.originalname}`)\n});\n\nconst upload = multer({ storage });\nconst tag = tags(['上传']);\n\nmodule.exports = class PublishRouter {\n\n    @request('post', '/api/apps/upload')\n    @summary(\"文件上传\")\n    @tag\n    @formData({\n        file: {type: 'file', required: true, description: '.apk、.ipa、.zip'},\n        appId: {type: 'string', required: true, description: '项目ID'},\n        platform: {type: 'string', required: true,enum:['ios','android','rn'],description: '平台'},\n        appVersion: {type: 'string', required: false, description: '目标版本'},\n        active: {type: 'bool', required: false, description: '是否启用'},\n        grayScaleSize: {type: 'number', required: false, default: 0, description: '是否启用'},\n        changeLog: {type: 'string', required: false, description: '发布说明'},\n        updateMode: {\n            type: 'string',\n            required: false,\n            default: 'silent',\n            enum: ['silent', 'normal', 'force'],\n            description: '更新方式'\n        },\n    })\n    @middlewares([upload.single('file')])\n    static async upload(ctx, next) {\n        let file = ctx.req.file;\n        console.log('file',file)\n        let uid = ctx.state.user.data._id;\n        let {\n            appId,\n            platform,\n            appVersion,\n            changeLog,\n            grayScaleSize = 0,\n            active = false,\n            updateMode = 'normal'\n        } = ctx.req.body;\n        let appInfo = await verify.checkApp(appId)\n        console.log('active',active)\n        await verify.checkRole(uid, appId, 'manager')\n        let version = await versionManager.releaseVersions(ctx.state.user.data, appInfo, {\n                appId, platform, appVersion, changeLog, grayScaleSize, active, updateMode, file\n            });\n        log.debug(version)\n        ctx.body = responseWrapper(version)\n    }\n\n}\n\n"]}